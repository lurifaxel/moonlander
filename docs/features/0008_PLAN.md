# Feature 0008 - Black Hole Hazards

## Context
Add **"Black holes, that can be placed when creating levels"** so custom terrain can include singularities that exert gravity on nearby objects. In play, **"When the ship is too close, it's turned into debris by the strong gravity and pulled into the dark hole."** The same pull should act on other physics objects — the prompt states **"Everything is affected by it's gravity, so e.g. bombs are also pulled into it if too close. Bomb explosions do not affect the black hole."** Visually, each hole must be **"completely black in the center"** with a rim where it **"looks like space is being pulled into it at the edges"**, rendered with pixel blocks that match the terrain’s cell size so it remains **"pixelated in the style, like the rest of the graphics. Same size of pixels as the ground."**

## Target files
- `index.html`: extend the editor placement tools, level data structures, physics update loop, rendering pipeline, and particle systems to support black holes and their interactions.
- `README.md`: describe the new black hole hazard, editor placement instructions, and gameplay behavior.
- `CHANGELOG.md`: record the addition of black-hole placement and gameplay effects.

## Technical plan
1. **Level data & state plumbing**
   - Extend the `terrain` structure (near the existing `solids` fields) with a `blackHoles` array. Initialize it in `generateTerrain()` and `initTerrainGrid()` so built-in levels default to an empty list while custom levels hold designer-defined holes.
   - Add `editorState.blackHoles` plus helper serialization (clone helpers similar to `cloneSolidsArray`) to preserve them when entering/leaving the editor, entering test mode, or regenerating the world (`enterEditor()`, `enterEditorTest()`, `restoreTerrainFromBaseline()`, `resetGame()` overrides).
   - When launching gameplay (`resetGame`), deep-copy `terrain.blackHoles` into an `activeBlackHoles` array so in-round mutations (e.g., consuming bombs) never alter the editor source.

2. **Editor tooling for placement**
   - Append `'blackHole'` to `editorState.placementOptions`, update `labelForPlacement()`/`updateEditorOverlay()` so the HUD, wheel cycling, and status panel expose the option.
   - Create helpers `editorPlaceBlackHole(worldX, worldY)` and `editorRemoveBlackHole(worldX, worldY)` that snap the hole center inside the playfield, avoid embedding it in solids (sample with `isSolidWorld`/`resolvePenetrationAt`), and enforce minimum spacing. Wire these into `endEditorStroke()` so a click without a drag while the option is active toggles a hole (Alt-click to delete is available because Alt already maps to carving — reuse that modifier or choose another that will not collide with painting, and document it in the overlay).
   - Persist editor changes by syncing `terrain.blackHoles = editorState.blackHoles` whenever the grid is rehydrated (`initEditorTerrain`, `enterEditor`, `returnToEditorFromTest`). Ensure camera presets and baseline cloning store hole arrays alongside the terrain solids during test runs.
   - Update `drawEditorGuides()` to render placement gizmos: outline the influence radius/event horizon with dashed circles and label the center so designers can see the gravity reach while editing.

3. **Gameplay physics & interactions**
   - Define new constants for black-hole tuning (e.g., `BLACK_HOLE_EVENT_RADIUS`, `BLACK_HOLE_PULL_RADIUS`, `BLACK_HOLE_PULL_STRENGTH`, `BLACK_HOLE_MAX_FORCE`) near the existing bomb constants.
   - Implement `applyBlackHoleGravity(entity)` that iterates active holes, computes a normalized vector, and applies `accel = strength / max(distance^2, minRadius^2)` capped to avoid instability. Invoke it for the lander inside `update()`, for live bombs inside `updateBombs()`, and for debris shards inside `updateDebris()` so “everything” feels the pull.
   - Add an `checkBlackHoleCapture()` pass inside `update()` that evaluates the lander against each hole’s event radius; on entry, call a new `consumeLanderIntoBlackHole(hole)` routine that halts thruster audio, flags `gameOver`, generates custom debris directed inward (reuse the debris array but seed velocities toward the hole), and sets an appropriate failure message like “Singularity capture!”. Skip `spawnExplosion()` so terrain stays intact and the effect matches “turned into debris…pulled into the dark hole.”
   - In `updateBombs()`, after gravity integration, detect bombs entering the event radius; flag them as `detonated`, remove them without calling `explodeBomb()`, and optionally spawn a small inward spark so the pull is visible. Ensure `applyExplosionEffects()` ignores black holes so the note “Bomb explosions do not affect the black hole.” holds even when a bomb detonates nearby.
   - Extend `updateDebris()` (and optionally wreck flames) to apply singularity pull; if fragments reach the event radius, fade them out quickly instead of bouncing to reinforce the swallow effect.

4. **Rendering & effects**
   - Introduce `drawBlackHoles()` before terrain lighting so holes appear embedded beneath gameplay entities. Render each using pixel blocks sized to `terrain.cellSize`, layering: (1) a solid black core disk, (2) a ring of darker-purple squares offset each frame to imply “space is being pulled into it at the edges,” (3) optional subtle star-stretch quads animated via a phase accumulator for motion. Maintain `ctx.imageSmoothingEnabled = false` throughout to keep the pixels crisp.
   - During gameplay draw, call `drawBlackHoles()` before `drawTerrain()` or immediately after depending on whether holes should eclipse terrain columns; in the editor overlay draw an outline + center marker so placement feedback remains clear.
   - Optionally add a faint screen-space gravitational lensing post effect by drawing additional translucent squares, but keep it additive so it doesn’t violate the “completely black in the center.”

5. **Documentation & verification**
   - Update the README’s gameplay and editor sections: explain how to place/remove black holes, their gravity behavior, and reiterate that bombs are sucked in and their explosions cannot damage a hole.
   - Add a CHANGELOG entry once the feature is implemented.
   - Plan manual tests: editor placement + removal, custom level test flight with the lander, bombs, and debris trajectories near a hole, ensuring capture triggers the debris animation and that built-in levels remain unchanged when no holes exist.

## Notes
- Remember to add the feature to `CHANGELOG.md` after implementation.
