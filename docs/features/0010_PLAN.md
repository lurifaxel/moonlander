# Feature 0010 - Configurable Meteor Strikes

## Context
Add fully-configurable meteors that "rain from above to strike the ground (or the ship, if it's in the way)". Meteors must "deform the terrain", "look cool" with fiery trails plus dusty impact plumes, and destroy the ship (and bombs) on contact. Designers need to place and tune meteors inside the level editor, including warning telegraphs (ghost flashes with synchronized warning audio) a few seconds before impact. Meteors always spawn from above the visible playfield and their configuration (arrival time, warning lead, speed, size) must be editable via clickable UI in the editor alongside existing keyboard shortcuts.

## Target files & touch points
- `index.html`
  - Extend level definitions (`levels` array) and editor state (`editorState`) to include meteor schedules.
  - Add meteor data helpers next to existing terrain/bomb utilities (`deformTerrainAt`, `spawnExplosion`, `applyExplosionEffects`).
  - Integrate meteor lifecycle into `resetGame`, `update(dt)`, draw routines (`drawTerrain`, `drawBombs`, etc.), and editor input handlers (`updateEditorOverlay`, mouse/wheel handlers).
  - Expand the inline audio helper (`audio` closure) with meteor warning/impact sounds.
- `CHANGELOG.md`: Record the addition of configurable meteor strikes.

## Technical plan
1. **Represent meteor schedules**
   - Define a `meteorSets` (name TBD) property on each level entry (and editor saves) describing meteors with verbatim-configurable fields: `spawn` position, `target` or `angle`, `speed`, `size`, `warningLeadMs`, and `delayMs`/`startTime` so they "come with different speeds from different angles and at different times" while clamping `spawn.y` to sit above the camera frustum.
   - In editor mode, add `editorState.meteors` alongside `editorState.blackHoles`, include it in `initEditorTerrain`, `restoreTerrainFromBaseline`, and cloning helpers so the array persists through edits/tests.
   - Update `resetGame` to clone the active level/editor meteor definitions into a runtime `activeMeteors` queue.

2. **Schedule warnings and impacts**
   - During `resetGame`, convert level meteor descriptors into timeline entries storing `warningTime = startTime - warningLeadMs` and `impactTime = startTime`.
   - In a new `updateMeteors(dt)` called from `update(dt)` before lander physics, advance timers to (a) trigger ghost previews when `now >= warningTime` but meteor not yet spawned, (b) spawn the live meteor projectile at `now >= impactTime`, and (c) remove finished meteors after impact effects complete.
   - When the warning begins, capture the straight-line path (start → predicted impact point) so the flashing ghost can be rendered and a warning beep played exactly once per meteor.

3. **Meteor physics & collisions**
   - Represent active meteors with current position, velocity (derived from `speed` and direction), radius based on configured size, and a bounding circle for collision tests.
   - Each frame, integrate position with gravity (reusing `g`), optionally allow horizontal motion based on angle.
   - Detect collisions with the terrain by sampling `groundYAt` along the meteor’s x and checking when its y-radius crosses the surface; clamp to contact point and trigger an explosion.
   - Check lander intersection (distance <= lander hull radius + meteor radius) and trigger `applyExplosionEffects`/`spawnExplosion` at the actual contact point to enforce "The ship explodes if struck by a meteor" even when the strike occurs mid-air.
   - Iterate `bombs` to trigger `explodeBomb` when a meteor overlaps an armed bomb so "This also applies to bombs".

4. **Impact consequences**
   - On impact, call a dedicated `resolveMeteorImpact(meteor, hitX, hitY)` helper that:
     - Plays a new audio cue for the explosion.
     - Calls `deformTerrainAt` with a depth/radius scaled by meteor size so terrain is carved out.
     - Uses existing particle systems (`debris`, `blastSmoke`, `spawnSmoke`) to emit the "huge cloud of dust" plus fiery burst.
     - Invokes `applyExplosionEffects` to ensure nearby bombs chain-react and the lander death radius applies when the meteor detonates slightly above ground.
   - Remove the meteor from the active list after spawning lingering smoke/trail particles.

5. **Rendering & VFX**
   - Add `drawMeteorWarnings()` to render the "ghost-version of the meteor" along its path with a flashing alpha synced to the warning timer, and `drawMeteors()` for live projectiles.
   - Live meteors should draw a streaked body (bright core + motion blur) and append trail particles each tick (reusing/expanding `smoke` or a dedicated array) to satisfy "streak of fire and smoke".
   - When an impact occurs, spawn a dust ring into `blastSmoke` (or a meteor-specific array) so the explosion produces a wide, dense cloud distinct from bombs.
   - Call both drawing helpers within the main render loop alongside other effects, ensuring editor mode also previews meteor placements (e.g., faint dotted path when selected).

6. **Audio cues**
   - Extend the `audio` module with `playMeteorWarning()` (short percussive ping) and `playMeteorImpact()` (bass-heavy boom layered with existing explosion if desired).
   - Trigger `playMeteorWarning()` exactly once when the warning ghost becomes visible, and `playMeteorImpact()` inside `resolveMeteorImpact`.

7. **Editor integration**
   - Append `'meteor'` to `editorState.placementOptions` and update `labelForPlacement()`/`updateEditorOverlay()` so designers see instructions like "Click: place meteor origin (Shift-click sets impact point)". Extend the overlay callouts to mention the new clickable configuration panel and digit hotkeys for placement switching (1=spawn, 2=landing, 3=black hole, 4=meteor).
   - Implement editor handlers so when the meteor tool is active: first click sets the spawn position (force the spawn Y above the current viewport), a drag or modifier click sets the target/impact, and use keyboard shortcuts (e.g., `[ / ]` to adjust size, `- / =` to tweak speed, `, / .` for warning lead time). Persist the pending configuration in `editorState.pendingMeteor` until confirmed.
   - Add a meteor configuration panel in `#editorPanel` with clickable number inputs for arrival time, warning lead, speed, and radius. The panel must edit either the currently selected meteor or the defaults for new meteors and stay in sync with keyboard adjustments/pending placements.
   - Store finalized meteors (with all tuning fields) in `editorState.meteors`, render them in `drawEditorGuides()` (include size in the label), and include them when exporting to runtime (`enterEditorTest`, `returnToEditorFromTest`).

8. **Documentation & housekeeping**
   - Update `updateEditorOverlay()` text and any on-screen debug info to mention meteor controls.
   - After implementation, document meteor usage in `README.md` if needed and always add an entry to `CHANGELOG.md` summarizing configurable meteor strikes.

## Notes
- Remember to add the feature to `CHANGELOG.md` after implementation.
