# Feature 0012 - Codebase Refactor for Readability and Testability

## Context
Moon Lander currently embeds 5k+ lines of CSS and JavaScript inside `index.html`, making the gameplay systems (terrain, physics, editor, audio, UI) difficult to reason about or test. The refactor must keep the experience in vanilla HTML + JS while splitting responsibilities into focused modules and adding a lightweight test harness.

## Plan
1. **Establish a module-friendly HTML shell**
   - Replace the inline `<style>` and `<script>` tags in `index.html` with links to `styles/main.css` and `<script type="module" src="src/main.js"></script>`.
   - Keep the existing DOM (canvas, menus, editor panel, touch controls) so layout/ARIA remain untouched.
   - Ensure bootstrap code defers until DOM content is ready; add fallback messaging if modules fail to load.
   - Remember to summarize this structural change in `CHANGELOG.md`.
2. **Extract and organize presentation styles**
   - Move the full style block into `styles/main.css`, grouping related rules (layout, touch controls, menus, editor panel) with comments.
   - Update asset paths if needed and confirm the stylesheet still targets the same IDs/classes.
3. **Modularize gameplay logic**
   - Create `src/constants.js` for shared enumerations and numeric tunables now spread throughout the script (e.g. `APP_MODE`, physics coefficients, meteor limits).
   - Add `src/state.js` to encapsulate mutable state: lander object, terrain descriptors, editor state, and runtime flags (`gameOver`, `exploded`, `meteorTimeline`, etc.). Provide factory/reset helpers such as `createLander()`, `createTerrain(cellSize)`, `createEditorState()`, and `resetRuntimeState(state)` to simplify reinitialization.
   - Extract terrain helpers (`initTerrainGrid`, `generateTerrain`, `fillColumnSolid`, `alignPadToSurface`, `isSolidWorld`, `resolvePenetrationAt`, `groundYAt`) into `src/terrain.js`, exporting pure functions that accept the terrain structure and operate deterministically.
   - Move input handling (keyboard/touch state, `incrementVirtualKey`, `decrementVirtualKey`, `syncCombinedKeyState`, touch preference toggles) into `src/input.js`, exposing an object with `attach(dom)`, `getKeyState()`, and cleanup APIs.
   - Split UI updates into `src/ui/` modules: `infoPanel.js`, `editorPanel.js`, `touchControls.js`, and `menus.js`. Each should accept DOM refs plus callbacks, updating classes/ARIA labels without touching gameplay logic directly.
   - Port audio routines (thruster envelopes, explosions, win fanfare) into `src/audio.js`, returning methods invoked by the game loop.
   - Collect the simulation and rendering logic (lander integration, collisions, bombs, meteors, FX arrays, camera management, drawing helpers) inside `src/gameLoop.js`, importing constants, state factories, terrain helpers, audio, and input. Expose a `createGameLoop(deps)` that returns `start()`, `stop()`, `setMode()`, `dropBomb()`, etc.
4. **Introduce a vanilla test harness**
   - Add `tests/runTests.js` that uses Node’s `assert` to run individual test modules and report pass/fail with process exit codes.
   - Create focused test files (e.g. `tests/terrain.test.js`, `tests/landerPhysics.test.js`) that import pure helpers from `src/terrain.js` and `src/gameLoop.js` (for `getLanderContactPoints` / physics integrators) to verify deterministic behaviour: pad alignment stays above terrain, `resolvePenetrationAt` returns outward normals, lander thrust produces expected velocity deltas, and meteor scheduling sorts by start time.
   - Keep the harness framework-free (no Jest/Mocha) and document how to run it in the README or CHANGELOG note.
5. **Implement the module bootstrap**
   - Author `src/main.js` to wire everything together: grab DOM nodes, instantiate state/terrain/audio/input managers, register event listeners (menu buttons, editor toolbar, touch toggle), and start the game loop with the correct app mode transitions (menu ↔ play ↔ editor/test).
   - Ensure resize handling, touch preference cycling, and editor tool updates delegate to the new modules without duplicating logic.
6. **Document the refactor**
   - Update `CHANGELOG.md` with an entry covering the modular architecture, stylesheet extraction, and the new test harness command.
   - Spot-check `README.md` and adjust any references to inline scripts/styles or the old startup instructions if necessary.
